sap.ui.define(["sap/ui/core/mvc/Controller"], function (Controller) {
	"use strict";
	return Controller.extend("ui5.ui5.controller.View1", {
		onInit: function () {
			var optionList = this.getView().byId("optionList");
			optionList.setSelectedKey("option1");
		},
		/**
		 *@memberOf ui5.ui5.controller.View1
		 */
		onButton: function (oEvent) {
			// This code was generated by the layout editor.
			var fileUploader = this.getView().byId("fileUploader");
			var domRef = fileUploader.getFocusDomRef();
			var file = domRef.files[0];
			if(file == null){
				sap.m.MessageToast.show("Please upload a file.");
				return;
			}
			var fileName = file.name;

			var formData = new FormData();
			// formData.append("files", file, fileName);

			var optionList = this.getView().byId("optionList");
			var selectedOption = optionList.getSelectedKey();
			var resultPanel = this.getView().byId("resultPanel");
			resultPanel.setBusy(true);
			$.ajax({
				url: '/node/leonardo/url',
				timeout: 3600000,
				// 'Accept': 'application/json',
				// 'Accept' : 'multipart/form-data',
				type: 'post',
				// processData: false,
				// contentType: false,
				data: {
					option: selectedOption
				},
				success: (data) => {
					console.log("[SUCCESS]", data);
					formData.append(data.ftype, file, fileName);
					for (let [key, value] of formData.entries()) {
						console.log(key, value);
					}
					$.ajax({
						url: data.url,
						timeout: 360000,
						type: 'post',
						headers: {
							'apiKey': data.api_key,
							'Accept': 'application/json'
						},
						contentType: false,
						processData: false,
						data: formData,
						success: (data) => {
							console.log('[SUCCESS]', data);
							this.drawImage(file, data, selectedOption);
							resultPanel.setBusy(false);
						},
						error: (err) => {
							console.error('[ERROR]', err);
							resultPanel.setBusy(false);
						}
					});
				},
				error: (err) => {
					console.error("[ERROR]", err);
					resultPanel.setBusy(false);
				}
			});
		},
		drawImage: function (baseImage, data, option) {
			var image = this.getView().byId("image");
			var path = URL.createObjectURL(baseImage);
			image.setSrc(path);

			var textOutput = this.getView().byId("textOutput");
			textOutput.setText(JSON.stringify(data));

			var formData = new FormData();
			var fileName = baseImage.name;
			formData.append("files", baseImage, fileName);

			$.ajax({
				url:'/node/image/box',
				type: 'post',
				timeout: 36000,
				processData: false,
				contentType: false,
				data: formData,
				success: (data) => {
					console.log(data);
				},
				error: (err) => {
					console.error(err);
				}
			});
		}
	});
});